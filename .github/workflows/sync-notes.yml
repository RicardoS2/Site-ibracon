name: Sync Notes → Quartz

on:
  repository_dispatch:
    types: [sync-notes]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout do Quartz repo
      - name: Checkout Quartz repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2️⃣ Clonar repo notes com token
      - name: Clone notes repo
        run: |
          git clone https://$NOTES_READ_TOKEN@github.com/RicardoS2/notes.git notes
        env:
          NOTES_READ_TOKEN: ${{ secrets.NOTES_READ_TOKEN }}

      # 3️⃣ Sincronizar os arquivos para content/
      - name: Sync notes into Quartz content
        run: |
          rsync -av --delete \
            notes/ content/ \
            --exclude ".obsidian/" \
            --exclude ".git/" \
            --exclude "_templates/" \
            --exclude ".github/"

      # 4️⃣ Configurar git
      - name: Configure Git
        run: |
          git config user.name "Quartz Sync Bot"
          git config user.email "actions@github.com"

      # 5️⃣ Adicionar apenas content/
      - name: Add changes
        run: git add content

      # 6️⃣ Commit se houver alterações
      - name: Commit changes
        run: |
          if ! git diff --staged --quiet; then
            git commit -m "sync: update notes from notes repo"
          fi

      # 7️⃣ Push para branch principal
      - name: Push changes
        run: git push
